---
header-includes:
    - \usepackage{ctex}
---

# 3-6 Temperature 解题报告

## 原理

先将所有观察站按 $x$ 坐标排序，然后逐个插入按 $y$ 坐标建立的可持久化线段树。查询时，先二分查找，分别得到 $x_1, x_2$ 所对应的版本号，然后分别查询这两个版本上 $[y_1,y_2]$ 中观察站的个数和温度之和。对两个版本上观察站的个数和温度之和分别做差，即得到$[x_1,x_2]\times[y_1,y_2]$内观察站的个数和温度之和。最后返回平均值即可。

## 遇到的问题

观察站的坐标取值范围高达$[-2^{31},2^{31})$，直接将每个可能的 $y$ 坐标作为叶节点建立线段树在空间上是不可行的。注意到 $1\leq n \leq 50000$，因而实际叶节点数量远远小于上述规模。建树之前先读入所有观察站的 $y$ 坐标，对其进行排序和去重，以这些 $y$ 坐标作为叶节点即可高效地建树。

## 复杂度分析

- 时间复杂度：
    + 预处理：
        * 将所有观察站按 $x$ 坐标排序：$\mathcal{O}(n\log{n})$
        * 对 $y$ 坐标排序：$\mathcal{O}(n\log{n})$
        * 对 $y$ 坐标去重：$\mathcal{O}(n)$
        * 初始化线段树：$\mathcal{O}(n\log{n})$
    + 更新线段树操作：每次$\mathcal{O}(\log{n})$，共$n$次，$\mathcal{O}(n\log{n})$。
    + 查询操作：每次$\mathcal{O}(\log{n})$，共$m$次，$\mathcal{O}(m\log{n})$。
    
    总计 $\mathcal{O}((m+n)\log{n})$.

- 空间复杂度：可持久化线段树，$\mathcal{O}(n\log{n})$。